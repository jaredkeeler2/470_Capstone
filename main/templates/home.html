{% load static %}
<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Home</title>
    <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
    <link rel="stylesheet" href="{% static 'style.css' %}" />
  </head>

  <body>
    <h1>Enrollment Trend Dashboard</h1>
    <p>
      <a href="/data/"><button>View Data</button></a>
      <a href="/graduates/"><button>Graduates Data</button></a>
    </p>

    <form>
      {% csrf_token %}
      <select id="dropdown" name="selected_course">
        <option value="" disabled selected>Select a course</option>
        {% for course in courses %}
          <option value="{{ course }}">{{ course }}</option>
        {% endfor %}
      </select>
    </form>

    <div id="enrollmentChart" style="position: relative;"></div>

    <script id="course-data" type="application/json">
      {{ course_data|safe }}
    </script>

    <script>
      const courseDataRaw = JSON.parse(
        document.getElementById("course-data").textContent
      );

      function termName(termCode) {
        if (!termCode) return "Unknown";
        const year = termCode.toString().slice(0, 4);
        const sem = termCode.toString().slice(4);
        if (sem === "01") return `Spring ${year}`;
        if (sem === "02") return `Summer ${year}`;
        if (sem === "03") return `Fall ${year}`;
        return year;
      }

      const groupedData = {};
      for (const entry of courseDataRaw) {
        const code = entry.code;
        const termLabel = entry.term_name || termName(entry.term);
        if (!groupedData[code])
          groupedData[code] = { x: [], y: [], mae: null, rmse: null };
        groupedData[code].x.push(termLabel);
        groupedData[code].y.push(entry.enrolled);
        if (entry.mae !== null && entry.rmse !== null) {
          groupedData[code].mae = entry.mae;
          groupedData[code].rmse = entry.rmse;
        }
      }

      const dropdown = document.getElementById("dropdown");
      const chartDiv = document.getElementById("enrollmentChart");

      dropdown.addEventListener("change", () => {
        const selected = dropdown.value;
        const data = groupedData[selected];
        if (!data) {
          Plotly.purge(chartDiv);
          return;
        }

        const lastIndex = data.x.length - 1;
        const mae = data.mae ?? "N/A";
        const rmse = data.rmse ?? "N/A";

        const tracePast = {
          type: "scatter",
          mode: "lines+markers",
          name: "Historical Data",
          x: data.x.slice(0, lastIndex),
          y: data.y.slice(0, lastIndex),
          line: { width: 3, color: "#007bff" },
          marker: { size: 8 }
        };

        const traceForecast = {
          type: "scatter",
          mode: "lines+markers+text",
          name: "Forecast",
          x: [data.x[lastIndex - 1], data.x[lastIndex]],
          y: [data.y[lastIndex - 1], data.y[lastIndex]],
          text: ["", "Forecast"],
          textposition: "top center",
          line: { width: 3, color: "#1E90FF", dash: "dot" },
          marker: { size: [0, 16], color: "#ff5733", symbol: "star",  line: { width: 0 }}
        };

        const traceMetrics = {
          type: "scatter",
          x: [null], 
          y: [null],
          mode: "lines",
          line: { color: "rgba(0,0,0,0)" },
          marker: { size: 0, opacity: 0 },
          name: `MAE: ${mae} <br>RMSE: ${rmse}`,
          hoverinfo: "none",
          showlegend: true,
          textfont: { color: "black", size: 0 },
        };

        const layout = {
          title: { text: selected },
          xaxis: { title: "Term" },
          yaxis: { title: "Enrollment Count" },
          margin: { t: 80, r: 80, b: 60, l: 80 },
          font: { size: 16 },
          plot_bgcolor: "#fafafa",
          paper_bgcolor: "#fafafa",
          legend: {
            x: 1.05,
            y: 1,
            bgcolor: "rgba(255,255,255,0)",
            bordercolor: "rgba(0,0,0,0)"
          }
        };

        Plotly.newPlot(chartDiv, [tracePast, traceForecast, traceMetrics], layout, {
          displayModeBar: true,
          responsive: true
        });
      });
    </script>
  </body>
</html>

{% load static %}
<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Home</title>
    <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
    <link rel="stylesheet" href="{% static 'style.css' %}" />
  </head>

  <body>
    <!--Title and navigation buttons-->
    <h1>Enrollment Trend Dashboard</h1>
    <p>
      <a href="/data/"><button>View Data</button></a>
      <a href="/graduates/"><button>Graduates Data</button></a>
    </p>
    <!--Dropdown menu for course form selection-->
    <form>
      {% csrf_token %}
      <select id="dropdown" name="selected_course">
        <option value="" disabled selected>Select a course</option>
        {% for course in courses %}
          <option value="{{ course }}">{{ course }}</option>
        {% endfor %}
      </select>
    </form>

    <!--Chart container (empty div)-->
    <div id="enrollmentChart" style="position: relative;"></div>

    <!--Stores course data from Django as a json object, use safe so json isnt converted into unreadable html-->
    <script id="course-data" type="application/json">
      {{ course_data|safe }}
    </script>

    <!--Converts the json into javascript objects for chart to use-->
    <script>
      const courseDataRaw = JSON.parse(
        document.getElementById("course-data").textContent
      );

      //Converts terms like 202503 to Fall 2025
      function termName(termCode) {
        if (!termCode) return "Unknown";
        const year = termCode.toString().slice(0, 4);
        const sem = termCode.toString().slice(4);
        if (sem === "01") return `Spring ${year}`;
        if (sem === "02") return `Summer ${year}`;
        if (sem === "03") return `Fall ${year}`;
        return year;
      }

      //Loops through the data points and organizes them by course code (x = terms, y = enrollment #, error metrics stored in legend)
      const groupedData = {};
      for (const entry of courseDataRaw) {
        const code = entry.code;
        const termLabel = entry.term_name || termName(entry.term);

        //Initialize group if it doesn't exist
        if (!groupedData[code]) {
          groupedData[code] = { 
            x: [], 
            y: [], 
            mae: null, 
            rmse: null 
          };
        }

        //Add data points
        groupedData[code].x.push(termLabel);
        groupedData[code].y.push(entry.enrolled);

        //Add error metrics if present
        const hasMetrics = entry.mae !== null && entry.rmse !== null;
        if (hasMetrics) {
          groupedData[code].mae = entry.mae;
          groupedData[code].rmse = entry.rmse;
        }
      }

      //Connects the javascript to the dropdown and chart in the html
      const dropdown = document.getElementById("dropdown");
      const chartDiv = document.getElementById("enrollmentChart");

      //Clears chart if there isn't a course selected
      dropdown.addEventListener("change", () => {
        const selected = dropdown.value;
        const data = groupedData[selected];
        if (!data) {
          Plotly.purge(chartDiv);
          return;
        }

        
        const lastIndex = data.x.length - 1; //Gets last datapoint for the forecast
        const mae = data.mae ?? "N/A"; //mae & rmse are displayed, but N/A if there isn't any mae & rmse value
        const rmse = data.rmse ?? "N/A";

        //Plots all historical enrollment data with blue lines (except for last point)
        const tracePast = {
          type: "scatter",
          mode: "lines+markers",
          name: "Historical Data",
          x: data.x.slice(0, lastIndex),
          y: data.y.slice(0, lastIndex),
          line: { width: 3, color: "#007bff" },
          marker: { size: 8 }
        };

        //Connects the last historical data point to the last data point (which is forecast value) with a dotted line, 
        const traceForecast = {
          type: "scatter",
          mode: "lines+markers+text",
          name: "Forecast",
          x: [data.x[lastIndex - 1], data.x[lastIndex]],
          y: [data.y[lastIndex - 1], data.y[lastIndex]],
          text: ["", "Forecast"],
          textposition: "top center",
          line: { width: 3, color: "#1E90FF", dash: "dot" },
          marker: { size: [0, 16], color: "#ff5733", symbol: "star",  line: { width: 0 }}
        };

        //Doesn't display visible chart data, just meant to add the MAE and RMSE to the legend
        const traceMetrics = {
          type: "scatter",
          mode: "lines",
          name: `MAE: ${mae} <br>RMSE: ${rmse}`,
          x: [null], 
          y: [null],
          line: { color: "rgba(0,0,0,0)" },
          marker: { size: 0, opacity: 0 },
          hoverinfo: "none",
        };

        //Chart styling
        const layout = {
          title: { text: selected },
          xaxis: { title: "Term" },
          yaxis: { title: "Enrollment Count" },
          margin: { t: 80, r: 80, b: 60, l: 80 },
          font: { size: 16 },
          plot_bgcolor: "#fafafa",
          paper_bgcolor: "#fafafa",
          legend: {
            x: 1.05,
            y: 1,
            bgcolor: "rgba(255,255,255,0)",
            bordercolor: "rgba(0,0,0,0)"
          }
        };

        //Renders chart
        Plotly.newPlot(chartDiv, [tracePast, traceForecast, traceMetrics], layout, {
          displayModeBar: true,
          responsive: true
        });
      });
    </script>
  </body>
</html>

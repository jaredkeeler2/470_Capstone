{% load static %}
<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Enrollment trends</title>
    <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
    <link rel="stylesheet" href="{% static 'style.css' %}" />
  </head>

  <body>
    <div id="header" style="position: top;"></div>
    <!--Title and navigation buttons-->
    <h1>CS&E Enrollment Trend Dashboard</h1>
  <p>
      <a href="{% if URL_PREFIX %}/{{ URL_PREFIX }}/data/{% else %}/data/{% endif %}">
          <button>UAA Data</button>
      </a>

      <a href="{% if URL_PREFIX %}/{{ URL_PREFIX }}/graduates/{% else %}/graduates/{% endif %}">
          <button>ASD Data</button>
      </a>

      <a href="{% if URL_PREFIX %}/{{ URL_PREFIX }}/model_info/{% else %}/model_info/{% endif %}">
          <button>Model Information</button>
      </a>
  </p>

    <!--Dropdown menu for course form selection-->
    <form>
      {% csrf_token %}
      <select id="dropdown" name="selected_course">
        <option value="" disabled selected>Select a course</option>
        {% for course in courses %}
          <option value="{{ course }}">{{ course }}</option>
        {% endfor %}
      </select>
    </form>

    <!--Chart container (empty div)-->
    <div id="enrollmentChart" style="position: relative;"></div>

    <!--Stores course data from Django as a json object, use safe so json isnt converted into unreadable html-->
    <script id="course-data" type="application/json">
      {{ course_data|safe }}
    </script>

    <!--Converts the json into javascript objects for chart to use-->
    <script>
  const courseDataRaw = JSON.parse(
    document.getElementById("course-data").textContent
  );

  const groupedData = {};
  for (const entry of courseDataRaw) {
    const code = entry.code;
    const termLabel = entry.term_name;

    if (!groupedData[code]) {
      groupedData[code] = { 
        title: entry.title || code,
        x: [], 
        y: [], 
        arima_forecast: null,
        sarima_forecast: null,
        arimax_forecast: null,
        sarimax_forecast: null,
        arima_mae: null,
        sarima_mae: null,
        arimax_mae: null,
        sarimax_mae: null,
        yearly_course: false
      };
    }

    //Historical data
    if (entry.enrolled !== null) {
      groupedData[code].x.push(termLabel);
      groupedData[code].y.push(entry.enrolled);
    }

    //Forecast data
    if (entry.arima_forecast !== null || entry.sarima_forecast !== null || entry.arimax_forecast !== null || entry.sarimax_forecast !== null) {
      groupedData[code].next_term = entry.term_name;
      groupedData[code].arima_forecast = entry.arima_forecast;
      groupedData[code].sarima_forecast = entry.sarima_forecast;
      groupedData[code].arimax_forecast = entry.arimax_forecast;
      groupedData[code].sarimax_forecast = entry.sarimax_forecast;
      groupedData[code].arima_mae = entry.arima_mae;
      groupedData[code].sarima_mae = entry.sarima_mae;
      groupedData[code].arimax_mae = entry.arimax_mae;
      groupedData[code].sarimax_mae = entry.sarimax_mae;
      groupedData[code].arima_val_terms = entry.arima_val_terms;
      groupedData[code].arima_val_preds = entry.arima_val_preds;
      groupedData[code].sarima_val_terms = entry.sarima_val_terms;
      groupedData[code].sarima_val_preds = entry.sarima_val_preds;
      groupedData[code].arimax_val_terms = entry.arimax_val_terms;
      groupedData[code].arimax_val_preds = entry.arimax_val_preds;
      groupedData[code].sarimax_val_terms = entry.sarimax_val_terms;
      groupedData[code].sarimax_val_preds = entry.sarimax_val_preds;
      groupedData[code].yearly_course = entry.yearly_course;
    }
  }

  const dropdown = document.getElementById("dropdown");
  const chartDiv = document.getElementById("enrollmentChart");
  const header = document.createElement("header");
  img = document.createElement("img");
  img.src = "https://www.uaa.alaska.edu/_template/assets/img/uaa_logo.svg";
  header.appendChild(img);
  document.getElementById("header").appendChild(header);

  

  dropdown.addEventListener("change", () => {
    const selected = dropdown.value;
    const data = groupedData[selected];
    if (!data) {
      Plotly.purge(chartDiv);
      return;
    }

    const lastTerm = data.x[data.x.length - 1];
    const hasForecast = data.arima_forecast || data.sarima_forecast || data.arimax_forecast || data.sarimax_forecast;
    const nextTerm = hasForecast ? (data.next_term) : "Insufficient Data";

    //Historical data
    const tracePast = {
      type: "scatter",
      mode: "lines+markers",
      name: "Historical Data",
      hoverinfo: "x+y",
      x: data.x,
      y: data.y,
      line: { width: 3, color: "#007bff" },
      marker: { size: 8 }
    };

    let maes = [data.arima_mae, data.arimax_mae];
    if (!data.yearly_course) {
      maes.push(data.sarima_mae, data.sarimax_mae);
    }
    maes = maes.filter(v => v !== null && !isNaN(v));
    const minMae = maes.length ? Math.min(...maes) : null;
    let bestModel = null;
    if (minMae !== null) {
      if (data.arima_mae === minMae ) bestModel = "arima";
      else if (data.sarima_mae === minMae) bestModel = "sarima";
      else if (data.arimax_mae === minMae) bestModel = "arimax";
      else if (data.sarimax_mae === minMae) bestModel = "sarimax";
    }

    //ARIMA forecast
    const traceArima = {
      type: "scatter",
      mode: "lines+markers+text",
      name: `ARIMA Forecast (Mean Absolute Error: ${data.arima_mae != null ? data.arima_mae.toFixed(1) : "N/A"})`,
      hoverinfo: "x+y",
      x: [lastTerm, nextTerm],
      y: [data.y[data.y.length - 1], data.arima_forecast],
      text: ["", "ARIMA"],
      textposition: "top center",
      line: { width: 3, color: "#ff5733", dash: "dot" },
      marker: { size: [0, 14], color: "#ff5733", symbol: data.arima_mae === minMae ? "star" : "circle" },
      opacity: data.arima_mae === minMae ? 1 : 0.5,
      showlegend: data.arima_forecast !== null && !isNaN(data.arima_forecast) ? true : false
    };

    //SARIMA forecast
    const traceSarima = {
      type: "scatter",
      mode: "lines+markers+text",
      name: `SARIMA Forecast (Mean Absolute Error: ${data.sarima_mae != null ? data.sarima_mae.toFixed(1) : "N/A"})`,
      hoverinfo: "x+y",
      x: [lastTerm, nextTerm],
      y: [data.y[data.y.length - 1], data.sarima_forecast],
      text: ["", "SARIMA"],
      textposition: "bottom center",
      line: { width: 3, color: "#ffa500", dash: "dot" },
      marker: { size: [0, 14], color: "#ffa500", symbol: data.sarima_mae === minMae ? "star" : "circle" },
      opacity: data.sarima_mae === minMae ? 1 : 0.5,
      showlegend: (data.sarima_forecast !== null && !isNaN(data.sarima_forecast) ? true : false)
    };

    //ARIMAX forecast
    const traceArimax = {
      type: "scatter",
      mode: "lines+markers+text",
      name: `ARIMAX Forecast (Mean Absolute Error: ${data.arimax_mae != null ? data.arimax_mae.toFixed(1) : "N/A"})`,
      hoverinfo: "x+y",
      x: [lastTerm, nextTerm],
      y: [data.y[data.y.length - 1], data.arimax_forecast],
      text: ["", "ARIMAX"],
      textposition: "top center",
      line: { width: 3, color: "#8000ff", dash: "dot" },
      marker: { size: [0, 14], color: "#8000ff", symbol: (data.arimax_mae ?? 0) === minMae ? "star" : "circle" },
      opacity: data.arimax_mae === minMae ? 1 : 0.5,
      showlegend: data.arimax_forecast !== null && !isNaN(data.arimax_forecast) ? true : false
    };

    //SARIMAX forecast
    const traceSarimax = {
      type: "scatter",
      mode: "lines+markers+text",
      name: `SARIMAX Forecast (Mean Absolute Error: ${data.sarimax_mae != null ? data.sarimax_mae.toFixed(1) : "N/A"})`,
      hoverinfo: "x+y",
      x: [lastTerm, nextTerm],
      y: [data.y[data.y.length - 1], data.sarimax_forecast],
      text: ["", "SARIMAX"],
      textposition: "bottom center",
      line: { width: 3, color: "#00cc44", dash: "dot" },
      marker: { size: [0, 14], color: "#00cc44", symbol: (data.sarimax_mae ?? 0) === minMae ? "star" : "circle" },
      opacity: data.sarimax_mae === minMae ? 1 : 0.5,
      showlegend: data.sarimax_forecast !== null && !isNaN(data.sarimax_forecast) ? true : false
    };

    let validationTrace = null;
    if (bestModel) {
      const colorMap = {
        arima: "#ff5733",
        sarima: "#ffa500",
        arimax: "#8000ff",
        sarimax: "#00cc44"
      };

      const valTerms = data[`${bestModel}_val_terms`];
      const valPreds = data[`${bestModel}_val_preds`];

      if (valTerms && valPreds) {
        const termLabels = valTerms.map(term => {
          const year = Math.floor(term / 100);
          const sem = term % 100;
          const semNames = { 1: "Spring", 2: "Summer", 3: "Fall" };
          return `${semNames[sem] || "Unknown"} ${year}`;
        });

        validationTrace = {
          type: "scatter",
          mode: "markers+text",
          name: `Validation (${bestModel.toUpperCase()})`,
          hoverinfo: "x+y",
          x: termLabels,
          y: valPreds,
          textposition: "top center",
          marker: {
            size: 12,
            color: colorMap[bestModel],
            symbol: "x"
          }
        };
      }
    }

    //Chart layout
    const layout = {
      title: { text: data.title || selected },
      xaxis: { title: "Term", automargin: true, tickfont: { size: 12 } },
      yaxis: { 
        title: "Enrollment Count",
        range: [0, null],
        automargin: true,
        rangemode: "tozero"
       },
      margin: { t: 80, r: 80, b: 60, l: 80 },
      font: { size: 15 },
      plot_bgcolor: "#fafafa",
      paper_bgcolor: "#fafafa",
      legend: {
        x: 1.05,
        y: 1,
        bgcolor: "rgba(255,255,255,0)",
        bordercolor: "rgba(0,0,0,0)",
        title: { text: "   ℹ️ Click legend items to hide or show data<br>", font: { size: 12, color: "#777"}}
      }
    };

    //Checks if the course is yearly to avoid plotting SARIMA/SARIMAX for those courses
    const traces = [tracePast, traceArima, traceArimax];
    if (!data.yearly_course) {
      traces.push(traceSarima, traceSarimax);
    }

    if (validationTrace) traces.push(validationTrace);
    var config = {
      responsive: true,
      displayModeBar: true,
      scrollZoom: true};

    Plotly.newPlot(chartDiv, traces, layout, config);
  });

  dropdown.value = "CSCE A101";
  dropdown.dispatchEvent(new Event("change"));

</script>
